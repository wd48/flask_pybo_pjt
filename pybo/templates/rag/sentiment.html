{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h3>ê°ì • ê¸°ë¡ ë¶„ì„</h3>
    <form id="sentiment-form">
        <div class="mb-3">
            <label class="form-label">ì„±ë³„ì€ ì–´ë–»ê²Œ ë˜ì‹­ë‹ˆê¹Œ?</label>
            <div>
                <input type="radio" id="gender-male" name="gender" value="ë‚¨ì„±" checked>
                <label for="gender-male">ë‚¨ì„±</label>
                <input type="radio" id="gender-female" name="gender" value="ì—¬ì„±">
                <label for="gender-female">ì—¬ì„±</label>
                <input type="radio" id="gender-other" name="gender" value="ê¸°íƒ€">
                <label for="gender-other">ê¸°íƒ€</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="age" class="form-label">ì—°ë ¹ëŒ€ëŠ” ì–´ë–»ê²Œ ë˜ì‹­ë‹ˆê¹Œ?</label>
            <select id="age" name="age" class="form-select">
                <option value="10ëŒ€">10ëŒ€</option>
                <option value="20ëŒ€">20ëŒ€</option>
                <option value="30ëŒ€" selected>30ëŒ€</option>
                <option value="40ëŒ€">40ëŒ€</option>
                <option value="50ëŒ€">50ëŒ€</option>
                <option value="60ëŒ€">60ëŒ€</option>
                <option value="70ëŒ€ì´ìƒ">70ëŒ€ì´ìƒ</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">E. ê°ì •(Emotion) ê±·ê¸° ì „ ê°€ì¥ í¬ê²Œ ëŠê¼ˆë˜ ê°ì • 1ê°€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</label>
            <div class="d-flex flex-wrap gap-2">
                <input type="radio" id="emotion-joy" name="emotion" value="ê¸°ì¨" class="btn-check">
                <label for="emotion-joy" class="btn btn-outline-primary">ê¸°ì¨</label>
                <input type="radio" id="emotion-calm" name="emotion" value="í‰ì˜¨" class="btn-check">
                <label for="emotion-calm" class="btn btn-outline-primary">í‰ì˜¨</label>
                <input type="radio" id="emotion-gratitude" name="emotion" value="ê°ì‚¬" class="btn-check">
                <label for="emotion-gratitude" class="btn btn-outline-primary">ê°ì‚¬</label>
                <input type="radio" id="emotion-calmness" name="emotion" value="ë‹´ë‹´í•¨" class="btn-check">
                <label for="emotion-calmness" class="btn btn-outline-primary">ë‹´ë‹´í•¨</label>
                <input type="radio" id="emotion-boredom" name="emotion" value="ì§€ë£¨í•¨" class="btn-check">
                <label for="emotion-boredom" class="btn btn-outline-primary">ì§€ë£¨í•¨</label>
                <input type="radio" id="emotion-tiredness" name="emotion" value="í”¼ê³¤í•¨" class="btn-check">
                <label for="emotion-tiredness" class="btn btn-outline-primary">í”¼ê³¤í•¨</label>
                <input type="radio" id="emotion-anxiety" name="emotion" value="ë¶ˆì•ˆ" class="btn-check">
                <label for="emotion-anxiety" class="btn btn-outline-primary">ë¶ˆì•ˆ</label>
                <input type="radio" id="emotion-depression" name="emotion" value="ìš°ìš¸" class="btn-check">
                <label for="emotion-depression" class="btn btn-outline-primary">ìš°ìš¸</label>
                <input type="radio" id="emotion-anger" name="emotion" value="ë¶„ë…¸" class="btn-check">
                <label for="emotion-anger" class="btn btn-outline-primary">ë¶„ë…¸</label>
                <input type="radio" id="emotion-other" name="emotion" value="ê¸°íƒ€" class="btn-check">
                <label for="emotion-other" class="btn btn-outline-primary">ê¸°íƒ€</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="meaning" class="form-label">M. ì˜ë¯¸(Meaning) ì™œ ê·¸ëŸ° ê°ì •ì„ ëŠê¼ˆëŠ” ì§€ ì ì–´ì£¼ì„¸ìš”.</label>
            <textarea id="meaning" name="meaning" class="form-control" rows="3"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">A. í–‰ë™(Action) ë‚˜ì˜ ê°ì •ì— ë„ì›€ì´ ëœ ì˜¤ëŠ˜ì˜ í–‰ë™ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.</label>
            <div class="d-flex flex-wrap gap-2">
                <input type="checkbox" id="action-walk" name="action" value="ê±·ê¸°" class="btn-check">
                <label for="action-walk" class="btn btn-outline-secondary">ê±·ê¸°</label>
                <input type="checkbox" id="action-barefoot" name="action" value="ë§¨ë°œê±·ê¸°" class="btn-check">
                <label for="action-barefoot" class="btn btn-outline-secondary">ë§¨ë°œê±·ê¸°</label>
                <input type="checkbox" id="action-affirmation" name="action" value="ê¸ì •í™•ì–¸" class="btn-check">
                <label for="action-affirmation" class="btn btn-outline-secondary">ê¸ì •í™•ì–¸</label>
                <input type="checkbox" id="action-breathing" name="action" value="ì‹¬í˜¸í¡" class="btn-check">
                <label for="action-breathing" class="btn btn-outline-secondary">ì‹¬í˜¸í¡</label>
                <input type="checkbox" id="action-talk" name="action" value="ëŒ€í™”" class="btn-check">
                <label for="action-talk" class="btn btn-outline-secondary">ëŒ€í™”</label>
                <input type="checkbox" id="action-stretch" name="action" value="ìŠ¤íŠ¸ë ˆì¹­" class="btn-check">
                <label for="action-stretch" class="btn btn-outline-secondary">ìŠ¤íŠ¸ë ˆì¹­</label>
                <input type="checkbox" id="action-music" name="action" value="ìŒì•…ë“£ê¸°" class="btn-check">
                <label for="action-music" class="btn btn-outline-secondary">ìŒì•…ë“£ê¸°</label>
                <input type="checkbox" id="action-rest" name="action" value="íœ´ì‹" class="btn-check">
                <label for="action-rest" class="btn btn-outline-secondary">íœ´ì‹</label>
                <input type="checkbox" id="action-writing" name="action" value="ê¸€ì“°ê¸°" class="btn-check">
                <label for="action-writing" class="btn btn-outline-secondary">ê¸€ì“°ê¸°</label>
                <input type="checkbox" id="action-other" name="action" value="ê¸°íƒ€" class="btn-check">
                <label for="action-other" class="btn btn-outline-secondary">ê¸°íƒ€</label>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">R. ì„±ì°° (Reflect) í–‰ë™ í›„, ì–´ë–¤ ê¸ì •ì ì¸ ë³€í™”ê°€ ëŠê»´ì§€ëŠ” ì§€ ëª¨ë‘ ì²´í¬í•´ì£¼ì„¸ìš”.</label>
            <div class="d-flex flex-wrap gap-2">
                <input type="checkbox" id="reflect-light" name="reflect" value="ê°€ë²¼ì›Œìš”" class="btn-check">
                <label for="reflect-light" class="btn btn-outline-success">ê°€ë²¼ì›Œìš”</label>
                <input type="checkbox" id="reflect-calm" name="reflect" value="í‰ì˜¨í•´ìš”" class="btn-check">
                <label for="reflect-calm" class="btn btn-outline-success">í‰ì˜¨í•´ìš”</label>
                <input type="checkbox" id="reflect-happy" name="reflect" value="ê¸°ë»ìš”" class="btn-check">
                <label for="reflect-happy" class="btn btn-outline-success">ê¸°ë»ìš”</label>
                <input type="checkbox" id="reflect-comfortable" name="reflect" value="í¸ì•ˆí•´ìš”" class="btn-check">
                <label for="reflect-comfortable" class="btn btn-outline-success">í¸ì•ˆí•´ìš”</label>
                <input type="checkbox" id="reflect-good" name="reflect" value="ì¢‹ì•„ìš”" class="btn-check">
                <label for="reflect-good" class="btn btn-outline-success">ì¢‹ì•„ìš”</label>
                <input type="checkbox" id="reflect-energetic" name="reflect" value="í™œë ¥ìˆì–´ìš”" class="btn-check">
                <label for="reflect-energetic" class="btn btn-outline-success">í™œë ¥ìˆì–´ìš”</label>
                <input type="checkbox" id="reflect-hopeful" name="reflect" value="í¬ë§ì ì´ì˜ˆìš”" class="btn-check">
                <label for="reflect-hopeful" class="btn btn-outline-success">í¬ë§ì ì´ì˜ˆìš”</label>
                <input type="checkbox" id="reflect-grateful" name="reflect" value="ê°ì‚¬í•´ìš”" class="btn-check">
                <label for="reflect-grateful" class="btn btn-outline-success">ê°ì‚¬í•´ìš”</label>
                <input type="checkbox" id="reflect-other" name="reflect" value="ê¸°íƒ€" class="btn-check">
                <label for="reflect-other" class="btn btn-outline-success">ê¸°íƒ€</label>
            </div>
        </div>
        <div class="mb-3">
            <label for="anchor" class="form-label">A. ê³ ì •(Anchor ) ì˜¤ëŠ˜ í•˜ë£¨, ë‚˜ë¥¼ ìœ„í•œ í•œë§ˆë””ë¥¼ ì ì–´ì£¼ì„¸ìš”.</label>
            <textarea id="anchor" name="anchor" class="form-control" rows="2"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-2">ë¶„ì„</button>
    </form>

      <div class="mt-4" id="resultArea" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h4>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h4>
          </div>
          <div class="card-body">
            <div id="sentimentResult" class="text-start" style="white-space: pre-wrap;"></div>
          </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">
              <h4>ğŸ“š ì „ë¬¸ê°€ ì¡°ì–¸ (ì°¸ê³  ìë£Œ)</h4>
            </div>
            <div class="card-body">
              <div id="expertAdvice" class="text-start" style="white-space: pre-wrap; font-size: 0.9em; color: #555;"></div>
            </div>
          </div>
      </div>
    </div>

    <script>
      document.getElementById('sentiment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const resultArea = document.getElementById('resultArea');
        const sentimentResult = document.getElementById('sentimentResult');
        const expertAdvice = document.getElementById('expertAdvice');
        
        // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
        sentimentResult.innerHTML = '';
        expertAdvice.innerHTML = '';
        resultArea.style.display = 'block';

        // 'AI ë¶„ì„ ê²°ê³¼' ì¹´ë“œ ë‚´ë¶€ì— ë¡œë”© UI ì‚½ì…
        sentimentResult.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; min-height: 150px;">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">AIê°€ ê°ì • ê¸°ë¡ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
          </div>
        `;

        const formData = new FormData(this);
        const params = new URLSearchParams();
        for (const pair of formData) {
          if (pair[0] === 'action' || pair[0] === 'reflect') {
            params.append(pair[0], pair[1]);
          } else {
            params.set(pair[0], pair[1]);
          }
        }

        const queryString = params.toString();
        const eventSource = new EventSource(`/chat/sentiment_analysis?${queryString}`);
        let fullResult = "";
        let isFirstAnswerChunk = true;

        eventSource.onmessage = function(event) {
          if (event.data === "[DONE]") {
            eventSource.close();
            return;
          }
          
          const data = JSON.parse(event.data);

          if (data.answer) {
            if (isFirstAnswerChunk) {
              sentimentResult.innerHTML = ''; // ì²« ë‹µë³€ ì¡°ê° ë„ì°© ì‹œ ë¡œë”© UI ì œê±°
              isFirstAnswerChunk = false;
            }
            sentimentResult.innerHTML += data.answer.replace(/\\n/g, '\n');
            fullResult += data.answer;
          }
          if (data.context) {
            expertAdvice.innerHTML = data.context.replace(/\\n/g, '\n');
          }
        };

        eventSource.addEventListener('end', function(event) {
            eventSource.close();
            // ë‹µë³€ì´ ì „í˜€ ì˜¤ì§€ ì•Šì€ ê²½ìš° (ì˜¤ë¥˜ ë“±), ë¡œë”© UI ëŒ€ì‹  ë©”ì‹œì§€ í‘œì‹œ
            if (isFirstAnswerChunk) {
                sentimentResult.innerHTML = "<p class='text-muted'>AIë¡œë¶€í„° ë‹µë³€ì„ ë°›ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
            }

            // ìµœì¢… ê²°ê³¼ë¥¼ ì„œë²„ì— ë¡œê·¸ë¡œ ì „ì†¡
            const logData = {
                gender: formData.get('gender'),
                age: formData.get('age'),
                emotion: formData.get('emotion'),
                meaning: formData.get('meaning'),
                action: formData.getAll('action').join(', '),
                reflect: formData.getAll('reflect').join(', '),
                anchor: formData.get('anchor'),
                result: fullResult
            };

            fetch('/chat/log_sentiment_result', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(logData)
            });
        });

        eventSource.onerror = function(err) {
          console.error("EventSource failed:", err);
          sentimentResult.innerHTML = "<p class='text-danger'>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>";
          eventSource.close();
        };
      });
    </script>
{% endblock %}